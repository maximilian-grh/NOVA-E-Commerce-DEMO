exports.onExecutePostLogin = async (event, api) => {
  try {
    /**
     * Check if new Auth0 user
     */
    if (event.stats.logins_count !== 1) {
      return;
    }

    /**
     * Check for data integrity
     */

    if (event.user.app_metadata.stripe_customer_id) {
      const error = `app_metadata for new user already has stripe_customer_id property.`;

      console.error(error);

      api.access.deny(
        "We could not create your account.\n" +
          "Please contact support for assistance."
      );

      return;
    }

    /**
     * Initialize Stripe library
     */

    const stripe = require("stripe")(event.secrets.STRIPE_SECRET_KEY);

    /**
     * Check if existing Stripe Customer
     */

    const stripeCustomerMatchesByEmail = await stripe.customers.list({
      email: event.user.email,
    });

    if (stripeCustomerMatchesByEmail.data.length > 0) {
      const error = `Stripe Customer with email ${event.user.email} already exists.`;

      console.error(error);

      api.access.deny(
        "We could not create your account.\n" +
          "Please contact support for assistance."
      );

      return;
    }

    /**
     * Create Stripe Customer
     */

    const newStripeCustomer = await stripe.customers.create({
      email: event.user.email,
      description: "Automatically generated by an Auth0 Action",
      metadata: { auth0_user_id: event.user.user_id },
    });

    /**
     * Add Stripe Customer ID to app_metadata
     */

    api.user.setAppMetadata("stripe_customer_id", newStripeCustomer.id);
  } catch (error) {
    console.error(error.message);

    api.access.deny(
      "We could not create your account.\n" +
        "Please contact support for assistance."
    );
  }
};